@page
@model Learn_Earn.Pages.Quizzes.TakeModel
@{
    Layout = "_Layout";
}

<h2>Take Quiz: @Model.Quiz?.Title</h2>
@if (ViewData["Error"] != null)
{
    <div class="alert alert-danger">
        <strong>Eroare la trimitere:</strong>
        <div>@Html.Raw(ModelState.Values.SelectMany(v => v.Errors).FirstOrDefault()?.ErrorMessage)</div>
    </div>
    <pre style="white-space:pre-wrap;word-break:break-word;">@ViewData["Error"]</pre>
}

<form method="post" enctype="multipart/form-data">
    <input type="hidden" name="id" value="@Model.Quiz?.Id" />
    @if (!string.IsNullOrEmpty(Model.Quiz?.AttachmentPath))
    {
        <div class="mb-3">
            <p><strong>Quiz file provided by professor:</strong> <a href="@Model.Quiz.AttachmentPath" download>@Model.Quiz.AttachmentFileName</a></p>
            <label class="form-label">Încarcă fișierul răspuns al studentului</label>
            <div class="d-flex gap-2">
                <input type="file" name="StudentSubmission" id="studentSubmissionInput" class="form-control" />
            </div>
        </div>
    }
    else
    {
        @for (int i = 0; i < (Model.Questions?.Count ?? 0); i++)
        {
            var q = Model.Questions[i];
            <div>
                <p><strong>Q@(i+1):</strong> @q.QuestionText</p>
                @{ 
                    var options = (q.Options ?? "").Split('|');
                    for (int oi = 0; oi < options.Length; oi++)
                    {
                        <div>
                            <input type="radio" name="Answers[@q.Id]" value="@oi" /> @options[oi]
                        </div>
                    }
                }
            </div>
        }
        <!-- Hidden file input only for non-file quizzes (used by the Attach button) -->
        <input type="file" name="StudentSubmission" id="studentSubmissionHidden" class="d-none" />
    }
    <div class="mt-3">
        <label class="form-label">(Opțional) Atașează un fișier ca răspuns</label>
        <div class="input-group mb-2">
            <input type="text" id="attachedFileName" class="form-control" placeholder="Niciun fișier selectat" readonly />
            <button type="button" class="btn btn-outline-secondary" id="attachBtn">Adaugă fișier</button>
        </div>
    </div>
    <button type="submit" class="btn btn-primary">Submit</button>
</form>

<script>
    (function(){
        const btn = document.getElementById('attachBtn');
        const hidden = document.getElementById('studentSubmissionHidden');
        const disp = document.getElementById('attachedFileName');
        const visible = document.getElementById('studentSubmissionInput');

        // Wire attach button to the visible input (file-based quiz) or the hidden input (non-file quiz)
        if (visible) {
            visible.addEventListener('change', function(e){
                const f = e.target.files[0];
                if (f) disp.value = f.name;
            });
        }

        if (btn) {
            btn.addEventListener('click', function(){
                // prefer visible input if present
                if (visible) {
                    visible.click();
                } else if (hidden) {
                    hidden.click();
                }
            });
        }

        if (hidden) {
            hidden.addEventListener('change', function(e){
                const f = e.target.files[0];
                if (f) disp.value = f.name;
            });
        }
    })();
</script>
