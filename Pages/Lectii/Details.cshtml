@page "{id:int}"
@model Learn_Earn.Pages.Lectii.DetailsModel
@{
    ViewData["Title"] = Model.Lesson.Title;
}

<h1>@Model.Lesson.Title</h1>
<p><strong>Language:</strong> @Model.Lesson.Language</p>
<p><strong>Difficulty:</strong> @Model.Lesson.Difficulty</p>
<p><strong>Duration (min):</strong> @Model.Lesson.DurationMinutes</p>
@if (TempData["QuizSubmittedMessage"] != null)
{
    <div class="alert alert-success">@TempData["QuizSubmittedMessage"]</div>
}
@if (ViewData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@ViewData["ErrorMessage"]</div>
}
<hr />
<div>
    @Html.Raw(Model.Lesson.Content)
</div>

@* Hidden hook for JS toast when XP/streak TempData is present *@
@{
    var toast = TempData["XpToastMessage"] as string;
    var kind = TempData["XpToastKind"] as string ?? "lesson";
}
@if (!string.IsNullOrEmpty(toast))
{
    <div data-xp-toast="@toast" data-xp-kind="@kind"></div>
}

<hr />
<div>
    @if (Model.QuizForLesson != null)
    {
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">There is a quiz for this lesson</h5>
                <p class="card-text">Title: @Model.QuizForLesson.Title</p>
                    @* Show student's validated grade if present *@
                    @if (Model.UserAttempt != null)
                    {
                        <div class="alert alert-secondary">
                            <strong>Your score:</strong> @Model.UserAttempt.Score / @Model.UserAttempt.Total
                            @if (!string.IsNullOrEmpty(Model.UserAttempt.ValidationNote))
                            {
                                <div><em>@Model.UserAttempt.ValidationNote</em></div>
                            }
                        </div>
                    }
                @if (User.IsInRole("Profesor") || User.IsInRole("Admin") || (Model.Progress != null && Model.Progress.CompletedSections > 0))
                {
                    <a class="btn btn-primary" asp-page="/Quizzes/Take" asp-route-id="@Model.QuizForLesson.Id">Take quiz</a>
                }
                else
                {
                    <button class="btn btn-secondary" disabled>Complete the lesson to unlock the quiz</button>
                }
            </div>
        </div>
    }
    <h4>Progress</h4>
    @if (Model.Progress != null && Model.Progress.CompletedSections > 0)
    {
        <p class="text-success">âœ“ Lesson completed</p>
    }
    else if (Model.Progress != null)
    {
        <p>Completed sections: @Model.Progress.CompletedSections</p>
        <form method="post" asp-page-handler="MarkSection" asp-route-id="@Model.Lesson.Id">
            <button type="submit" class="btn btn-primary">Mark lesson as completed</button>
        </form>
    }
    else
    {
        <p>You have not started this lesson.</p>
        <form method="post" asp-page-handler="MarkSection" asp-route-id="@Model.Lesson.Id">
            <button type="submit" class="btn btn-primary">Mark lesson as completed</button>
        </form>
    }
</div>

@if (!string.IsNullOrEmpty(Model.Lesson.AttachmentPath))
{
    <div class="mt-3">
        <h4>Attached files</h4>
        <p>
            <a class="btn btn-outline-secondary" href="@Model.Lesson.AttachmentPath" download="@Model.Lesson.AttachmentFileName">
                Download: @Model.Lesson.AttachmentFileName
            </a>
        </p>
    </div>
}

@* Professor inline review panel when opened with a notificationId *@
@if (Model.NotificationForProfessor != null)
{
    <hr />
    <div class="card mb-3">
        <div class="card-header">Student review: @(Model.StudentForReview?.UserName ?? Model.NotificationForProfessor.StudentUserId)</div>
        <div class="card-body">
            @if (Model.QuizForLesson == null)
            {
                <div class="alert alert-info">There is no quiz for this lesson.</div>
                <div class="mb-2">
                    <a class="btn btn-secondary" asp-page="/Quizzes/Create" asp-route-lessonId="@Model.Lesson.Id" asp-route-notificationId="@Model.NotificationForProfessor.Id" asp-route-returnUrl="@Url.Page("/Lectii/Details", new { id = Model.Lesson.Id, notificationId = Model.NotificationForProfessor.Id })">Create quiz for this lesson</a>
                </div>
                <form method="post" asp-page-handler="ValidateAttempt">
                    <input type="hidden" name="ValidationInput.NotificationId" value="@Model.NotificationForProfessor.Id" />
                    <button type="submit" class="btn btn-primary">Mark as handled</button>
                </form>
            }
            else
            {
                <form method="post" asp-page-handler="ValidateAttempt">
                    <input type="hidden" name="ValidationInput.NotificationId" value="@Model.NotificationForProfessor.Id" />
                    <div class="mb-2">
                        <label class="form-label">Score obtained</label>
                        <input class="form-control" type="number" name="ValidationInput.Score" value="0" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Total points</label>
                        <input class="form-control" type="number" name="ValidationInput.Total" value="@Model.QuizQuestions.Count" />
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="ValidationInput.Passed" id="passedCheck" />
                        <label class="form-check-label" for="passedCheck">The student passed the quiz</label>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Note / comment</label>
                        <textarea class="form-control" name="ValidationInput.Note"></textarea>
                    </div>
                    <button class="btn btn-success" type="submit">Validate and grant</button>
                </form>
            }
        </div>
    </div>
}
